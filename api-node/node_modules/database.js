/*global require: true, exports: true, console: true, process: true */
var 
utils = require('utils'),
mongodb = require('mongodb');

function Database(host, port, database) {
	var server = new mongodb.Server(host, port, {});
	this.client = new mongodb.Db(database, server, {});
}

Database.prototype = {
	
	_active: false,
	
	_open: function(callback) {
		var database = this;
		this.client.open(function(error){
			if (error) {
				throw error;
			} else {
				process.on('SIGTERM', utils.applier(database, database.close));
				database._active = true;
				callback.call(database, database);
			}
		});
	},
	
	_collection: function(name, callback) {
		var database = this;
		if (this._active) {
			this.client.collection(name, function(error, collection) {
				if (error) { console.error(error); }
				callback.call(this, collection);
			});
		} else {
			console.error("Unable to get collection %s, DB is not connected!", name);
		}
	},
	
	find: function(options, callback) {
		options = utils.extend({
			query: {},
			options: {},
			fields: {},
			collection: ''
		}, options || {});
		this._collection(options.collection, function(collection){
			if (collection) {
				var query = collection.find(options.query, options.fields, options.options);
				query.toArray(function(error, documents){
					documents = documents || [];
					if (error) { console.error(error); }
					callback.call(null, documents);
				});
			} else {
				callback.call(null, []);
			}
		});
	},
	
	_close: function() {
		this.client.close();
		this._active = false;
	}
};

exports.connect = function(config, callback) {
	var host = config.get('DOTCLOUD_DATA_MONGODB_HOST'),
		port = config.get('DOTCLOUD_DATA_MONGODB_PORT'),
		database = config.get('DOTCLOUD_DATA_MONGODB_DATABASE');
	database = new Database(host, port, database);
	database._open(callback);
};