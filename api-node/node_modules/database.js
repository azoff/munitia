/*global require: true, exports: true, console: true, process: true */
var 
utils = require('utils'),
mongodb = require('mongodb');

function Database(host, port, database, username, password) {
	var server = new mongodb.Server(host, port, {auto_reconnect: true}, {});
	this.client = new mongodb.Db(database, server, {});
	this.username = username;
	this.password = password;
}

Database.prototype = {
	
	_active: false,
	
	_open: function(callback) {
		var database = this;
		this.client.open(function(error){
			if (error) {
				throw error;
			} else {
				process.on('SIGTERM', utils.applier(database, database.close));
				database._active = true;
				database.client.authenticate(database.username, database.password, 
											 function(err, client) {
												 if (err != null) {
													 console.error('ERROR authenticating: ' + err);
													 process.exit(2);
												 }
											 });
				callback.call(database, database);
			}
		});
	},
	
	_collection: function(name, callback) {
		var database = this;
		if (this._active) {
			this.client.collection(name, function(error, collection) {
				if (error) { console.error(error); }
				callback.call(this, collection);
			});
		} else {
			console.error("Unable to get collection %s, DB is not connected!", name);
		}
	},
	
	find: function(options, callback) {
		options = utils.extend({
			query: {},
			options: {},
			fields: {},
			collection: ''
		}, options || {});
		console.error('creating collection');
		this._collection(options.collection, function(collection){
				console.error('collection opened, collection=' + collection);
			if (collection) {
				var query = collection.find(options.query, options.fields, options.options);
				console.error('called collection.find');
				query.toArray(function(error, documents){
				console.error('called query.toArray() callback, error=' + error + ' docs=' + documents);
					documents = documents || [];
					if (error) { console.error(error); }
					callback.call(null, documents);
				});
				console.error('after query.toArray');
			} else {
				callback.call(null, []);
			}
		});
	},

	update: function(options, callback) {
		options = utils.extend({
				critera: {},
				doc: {},
				options: {}
			}, options || {});
		this._collection(options.collection, function(collection) {
		    if (collection) {
				console.error('updating ' + collection);
				collection.update(options.criteria, options.doc, options.options, function(err, errors) {
						if (err) console.error(err);
						if (errors) console.error(errors);
						callback.call(null, errors);
					});
			} else {
				callback.call(null, []);
			}
		});
	},
		
	insert: function(options, callback) {
		options = utils.extend({
			docs: [],
			collection: ''
		}, options || {});
		this._collection(options.collection, function(collection){
			if (collection) {
				collection.insert(options.docs, function(error, documents) {
					documents = documents || [];
					if (error) { console.error(error); }
					callback.call(null, documents);
				});
			} else {
				callback.call(null, []);
			}
		});
	},
	
	_close: function() {
		this.client.close();
		this._active = false;
	}
};

exports.connect = function(config, callback) {
	var host = config.get('DOTCLOUD_DATA_MONGODB_HOST'),
        port = config.get('DOTCLOUD_DATA_MONGODB_PORT'),
        username = config.get('DOTCLOUD_DATA_MONGODB_LOGIN'),
        password = config.get('DOTCLOUD_DATA_MONGODB_PASSWORD'),
        dbname = config.get('DOTCLOUD_DATA_MONGODB_DATABASE');
	
	database = new Database(host, port, dbname, username, password);
	database._open(callback);
};